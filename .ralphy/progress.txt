# Ralphy Progress Log

## 2026-02-04: Task 1 - Project scaffold + config

### Completed:
- Created Go module `github.com/dgnsrekt/discorgeous-go`
- Set up directory structure: `cmd/discorgeous/`, `internal/config/`, `internal/logging/`
- Implemented config loader (`internal/config/config.go`) with:
  - Environment variable loading for Discord, HTTP, TTS, and behavior settings
  - Sane defaults (port 8080, 5m idle timeout, 1000 max text length, etc.)
  - Validation for all config values
  - Helper functions for parsing env vars (string, int, duration)
- Implemented structured logging (`internal/logging/logging.go`) using Go's `log/slog`:
  - Supports text and JSON output formats
  - Configurable log levels (debug, info, warn, error)
- Created main entry point (`cmd/discorgeous/main.go`) with:
  - Config loading and validation
  - Logger initialization
  - Graceful shutdown handling (SIGINT/SIGTERM)
- Wrote comprehensive tests:
  - `internal/config/config_test.go`: Tests for Load(), Validate(), and helper functions
  - `internal/logging/logging_test.go`: Tests for New() and ParseLevel()

### Verification:
- `go test ./...` - PASSED
- `go vet ./...` - PASSED
- `gofmt -l .` - No issues (after formatting fix)

## 2026-02-04: Task 2 - HTTP enqueue API

### Completed:
- Implemented HTTP server (`internal/api/server.go`) with:
  - Server struct wrapping http.Server with config and logger
  - Routes for `GET /v1/healthz` and `POST /v1/speak`
  - Configurable read/write/idle timeouts
  - Start() and Shutdown() methods for lifecycle management
- Implemented bearer auth middleware (`internal/api/middleware.go`) with:
  - `Authorization: Bearer <token>` header validation
  - Case-insensitive "Bearer" prefix handling
  - Skip auth when no BEARER_TOKEN is configured (dev-friendly)
  - JSON error responses for auth failures
- Implemented handlers (`internal/api/handlers.go`) with:
  - SpeakRequest struct: text (required), voice, interrupt, ttl_ms, dedupe_key
  - SpeakResponse struct: job_id, message
  - Payload validation: required text, max text length, non-negative TTL
  - Default voice fallback from config
  - Placeholder job ID (actual queue integration in Task 3)
- Updated main.go to start HTTP server with graceful shutdown
- Wrote comprehensive tests:
  - `internal/api/server_test.go`: Tests for healthz and speak endpoints
  - `internal/api/middleware_test.go`: Tests for auth middleware scenarios

### Verification:
- `go test ./...` - PASSED
- `go vet ./...` - PASSED
- `gofmt -l .` - No issues

## 2026-02-04: Task 3 - Queue + playback worker

### Completed:
- Implemented SpeakJob type (`internal/queue/job.go`) with:
  - Unique job ID generation using google/uuid
  - Text, voice, interrupt, TTL, dedupe_key fields
  - CreatedAt/ExpiresAt timestamps
  - IsExpired() method for TTL checking
- Implemented bounded queue (`internal/queue/queue.go`) with:
  - Configurable capacity limit (ErrQueueFull when exceeded)
  - Dedupe key tracking (ErrDuplicateJob for duplicates)
  - Thread-safe enqueue/dequeue operations
  - Len() method for queue depth reporting
- Implemented single playback worker goroutine with:
  - SetPlaybackHandler() for TTS integration point
  - Sequential job processing (FIFO order)
  - Automatic skipping of expired jobs
  - Start()/Stop() lifecycle methods
- Implemented interrupt semantics with:
  - Interrupt() method cancels current playback via context
  - Clears all pending jobs from queue
  - Resets dedupe key tracking
- Implemented auto-leave idle timer with:
  - Configurable idle timeout (from config.AutoLeaveIdle)
  - SetIdleCallback() for voice disconnect integration
  - Timer resets when new jobs are processed
  - Timer paused during active playback
- Integrated queue with API handlers:
  - Updated Server to accept queue parameter
  - handleSpeak() now creates real jobs with unique IDs
  - Handles ErrQueueFull (503), ErrDuplicateJob (409)
  - Interrupt flag triggers queue.Interrupt() before enqueue
  - TTL applied from request or config default
- Updated main.go to wire up queue with placeholder handlers
- Wrote comprehensive tests:
  - `internal/queue/job_test.go`: Tests for job creation, expiry, uniqueness
  - `internal/queue/queue_test.go`: Tests for enqueue, capacity, dedupe, interrupt, worker processing, expired job skipping, cancellation, idle callback
  - Updated `internal/api/server_test.go` to use queue

### Verification:
- `go test ./...` - PASSED
- `go vet ./...` - PASSED
- `gofmt -l .` - No issues

## 2026-02-04: Task 4 - TTS engine (Piper)

### Completed:
- Implemented `Engine` interface (`internal/tts/engine.go`) with:
  - `SynthesizeRequest` struct containing text and voice parameters
  - `AudioResult` struct with data bytes, format, sample rate, and channels
  - `Reader()` method on AudioResult for streaming audio data
  - `Engine` interface with `Synthesize(ctx, req)` and `Name()` methods
- Implemented TTS engine registry (`internal/tts/registry.go`) with:
  - `NewRegistry()` constructor
  - `Register()` to add engines (first registered becomes default)
  - `Get()` to retrieve engine by name
  - `Default()` to get the default engine
  - `SetDefault()` to change the default engine
  - `List()` to enumerate all registered engine names
  - Thread-safe operations with sync.RWMutex
  - Error types: ErrEngineNotFound, ErrEngineExists
- Implemented `PiperEngine` (`internal/tts/piper.go`) with:
  - Configuration struct for binary path, model path, and default voice
  - Binary existence validation using exec.LookPath
  - Model path validation (required)
  - Synthesize() invokes piper with --model and --output-raw flags
  - Optional --speaker flag for voice selection
  - Context cancellation support for interrupts
  - Raw PCM output wrapped in WAV header for consistent format
  - Helper functions for WAV header generation (wrapRawPCMAsWAV)
  - Error types: ErrPiperNotFound, ErrNoModelSpecified, ErrSynthesisFailed
- Audio artifact contract decision: In-memory WAV bytes (not file-based)
  - AudioResult.Data contains full WAV with 44-byte header
  - Piper outputs raw 16-bit PCM at 22050 Hz mono
  - WAV wrapper added for format consistency
- Wrote comprehensive tests:
  - `internal/tts/engine_test.go`: AudioResult reader tests, empty data handling
  - `internal/tts/registry_test.go`: Register, Get, Default, SetDefault, List tests
  - `internal/tts/piper_test.go`: Name, configuration validation, WAV header generation tests

### Verification:
- `go test ./...` - PASSED
- `go vet ./...` - PASSED
- `gofmt -l .` - No issues
